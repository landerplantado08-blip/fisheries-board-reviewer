<script>
        // --- APP LOGIC ---
        let currentQuiz = [];
        let qIndex = 0;
        let score = 0;
        let activeSubject = "";
        let geminiKey = localStorage.getItem('geminiKey');
        let currentUser = localStorage.getItem('username');
        
        // Placeholder for Cloud functions (inactive)
        window.syncUserToCloud = () => {};
        window.saveScoreToCloud = () => {};
        window.fetchLeaderboard = () => {};

        // Login Handler
        window.handleLogin = () => {
            const name = document.getElementById('username-input').value.trim();
            if (!name) return alert("Please enter a name!");
            currentUser = name;
            localStorage.setItem('username', name);
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('home-screen').classList.remove('hidden');
            updateUserDisplay();
        };

        window.logout = () => {
            localStorage.removeItem('username');
            location.reload();
        };
        
        window.setTheme = (t) => { 
            localStorage.setItem('theme', t); 
            if(t==='dark') document.documentElement.classList.add('dark'); 
            else document.documentElement.classList.remove('dark'); 
        };
        
        window.updateUserDisplay = () => {
            if(document.getElementById('user-greeting')) document.getElementById('user-greeting').textContent = currentUser;
            if(document.getElementById('settings-username')) document.getElementById('settings-username').textContent = currentUser;
        };

        window.startQuiz = (count) => {
            let pool = [];
            // Ensure quizData exists
            if (!window.quizData) {
                alert("Database not loaded yet. Please wait a second and try again.");
                return;
            }

            if (activeSubject === "Mock Exam") {
                Object.values(window.quizData).forEach(arr => pool.push(...arr));
            } else {
                pool = window.quizData[activeSubject];
            }

            if(!pool || pool.length === 0) { 
                alert("No questions found for " + activeSubject + ". Please check the JS files."); 
                return; 
            }

            // Shuffle and slice
            pool = [...pool].sort(() => 0.5 - Math.random());
            const actualCount = Math.min(count, pool.length);
            currentQuiz = pool.slice(0, actualCount);
            qIndex = 0; 
            score = 0;

            // UI Updates
            document.getElementById('q-total').textContent = currentQuiz.length;
            document.getElementById('quiz-lbl').textContent = activeSubject;
            closeSubScreen();
            document.getElementById('quiz-screen').classList.add('active');
            loadQuestion();
        };

        window.loadQuestion = () => {
            const q = currentQuiz[qIndex];
            document.getElementById('q-curr').textContent = qIndex + 1;
            document.getElementById('progress').style.width = `${((qIndex)/currentQuiz.length)*100}%`;
            document.getElementById('q-text').textContent = q.q;
            
            // Reset Controls
            const controls = document.getElementById('quiz-controls');
            controls.classList.add('hidden');
            controls.classList.remove('flex'); // Remove flex to ensure hidden works

            const opts = document.getElementById('options');
            opts.innerHTML = '';
            
            // Randomize Options (Optional: remove .sort if you want fixed order)
            // const shuffledOpts = [...q.opts].sort(() => 0.5 - Math.random()); 
            
            q.opts.forEach(opt => {
                const btn = document.createElement('button');
                // Use !important logic via inline styles or specific classes if Tailwind gives trouble, 
                // but standard classes usually work. Added border-2 for visibility.
                btn.className = "option-btn w-full text-left p-4 card rounded-lg hover:bg-blue-50 dark:hover:bg-slate-800 transition border-2 border-transparent";
                btn.textContent = opt;
                btn.onclick = () => window.checkAnswer(btn, opt, q.a);
                opts.appendChild(btn);
            });
        };

        window.checkAnswer = (btn, sel, corr) => {
            // Prevent multiple clicks
            if(!document.getElementById('quiz-controls').classList.contains('hidden')) return;

            const allBtns = document.querySelectorAll('.option-btn');
            
            // 1. Highlight the Selected Button
            if (sel === corr) {
                score++;
                btn.classList.remove('border-transparent', 'hover:bg-blue-50');
                btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
            } else {
                btn.classList.remove('border-transparent', 'hover:bg-blue-50');
                btn.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
            }

            // 2. Always show the Correct Answer
            allBtns.forEach(b => {
                if(b.textContent === corr) {
                    b.classList.remove('border-transparent', 'hover:bg-blue-50');
                    b.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                }
                b.disabled = true; // Disable all buttons after choice
            });

            // 3. Show Next Button
            const controls = document.getElementById('quiz-controls');
            controls.classList.remove('hidden');
            controls.classList.add('flex');
        };

        window.nextQuestion = () => {
            qIndex++;
            if(qIndex < currentQuiz.length) {
                window.loadQuestion();
            } else {
                window.finishQuiz();
            }
        };

        window.finishQuiz = () => {
            const pct = Math.round((score / currentQuiz.length) * 100);
            
            // Save Local
            let stats = JSON.parse(localStorage.getItem('fisheriesPerformance')) || {totalQ:0, scores:[], subjectStats: {}};
            stats.totalQ += currentQuiz.length;
            stats.scores.push({ date: new Date().toLocaleDateString(), subj: activeSubject, score: pct });
            
            if (!stats.subjectStats[activeSubject]) stats.subjectStats[activeSubject] = { total: 0, correct: 0 };
            stats.subjectStats[activeSubject].total += currentQuiz.length;
            stats.subjectStats[activeSubject].correct += score;
            
            localStorage.setItem('fisheriesPerformance', JSON.stringify(stats));
            
            updateDashboard();
            
            document.getElementById('final-score').textContent = pct + "%";
            document.getElementById('final-msg').textContent = pct > 75 ? "Excellent!" : "Keep reviewing.";
            
            document.getElementById('quiz-screen').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');
        };

        window.updateDashboard = () => {
            const stats = JSON.parse(localStorage.getItem('fisheriesPerformance')) || {totalQ:0, scores:[], subjectStats: {}};
            document.getElementById('home-count').textContent = stats.scores.length;
            
            const avg = stats.scores.length ? Math.round(stats.scores.reduce((a,b)=>a+b.score,0)/stats.scores.length) : 0;
            document.getElementById('home-avg').textContent = avg + "%";
            
            // Activity List
            const cont = document.getElementById('stats-container');
            cont.innerHTML = '';
            if(stats.scores.length === 0) cont.innerHTML = '<p class="text-gray-400 text-center">No quizzes yet.</p>';
            
            stats.scores.slice(-5).reverse().forEach(s => {
                cont.innerHTML += `<div class="flex justify-between items-center p-3 border-b border-gray-100 dark:border-gray-800"><div><p class="font-semibold">${s.subj}</p><p class="text-xs text-gray-400">${s.date}</p></div><span class="font-bold ${s.score>=75?'text-green-500':'text-orange-500'}">${s.score}%</span></div>`;
            });

            // Bars
            const breakCont = document.getElementById('subject-breakdown');
            breakCont.innerHTML = '';
            
            // Ensure Mock Exam or other keys exist in stats even if empty
            const allSubjects = ["Aquaculture", "Capture Fisheries", "Ecology & Resources", "Post-Harvest"];
            
            allSubjects.forEach(sub => {
                const subData = stats.subjectStats[sub] || { total: 0, correct: 0 };
                const subPct = subData.total === 0 ? 0 : Math.round((subData.correct / subData.total) * 100);
                
                breakCont.innerHTML += `
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span>${sub}</span>
                            <span class="font-bold">${subPct}%</span>
                        </div>
                        <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full ${subPct >= 75 ? 'bg-green-500' : 'bg-blue-500'}" style="width: ${subPct}%"></div>
                        </div>
                    </div>`;
            });
        };

        window.switchDashboardTab = (tab) => {
            if(tab === 'my-stats') {
                document.getElementById('view-my-stats').classList.remove('hidden');
                document.getElementById('view-leaderboard').classList.add('hidden');
                document.getElementById('tab-my-stats').classList.add('bg-white', 'shadow-sm');
                document.getElementById('tab-leaderboard').classList.remove('bg-white', 'shadow-sm');
                window.updateDashboard();
            } else {
                document.getElementById('view-my-stats').classList.add('hidden');
                document.getElementById('view-leaderboard').classList.remove('hidden');
                document.getElementById('tab-leaderboard').classList.add('bg-white', 'shadow-sm');
                document.getElementById('tab-my-stats').classList.remove('bg-white', 'shadow-sm');
                // Offline mode message
                document.getElementById('leaderboard-container').innerHTML = "<div class='text-center py-8'><p class='text-sm text-gray-500'>Offline Mode.</p></div>";
            }
        }

        window.openSetup = (sub) => { 
            activeSubject = sub; 
            document.getElementById('setup-subject').textContent = sub; 
            document.getElementById('setup-screen').classList.add('active'); 
        };
        
        window.closeSubScreen = () => document.querySelectorAll('.sub-screen').forEach(s => s.classList.remove('active'));
        
        window.resetProgress = () => { 
            if(confirm("Reset local data?")) { 
                localStorage.removeItem('fisheriesPerformance'); 
                location.reload(); 
            } 
        };

        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            if(id !== 'login-screen') document.getElementById('login-screen').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
            
            // Update Nav Icons
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.replace('text-blue-600', 'text-gray-400'));
            
            if(id.includes('home')) document.querySelector('nav button:nth-child(1)').classList.replace('text-gray-400', 'text-blue-600');
            if(id.includes('subject')) document.querySelector('nav button:nth-child(2)').classList.replace('text-gray-400', 'text-blue-600');
            if(id.includes('dashboard')) document.querySelector('nav button:nth-child(3)').classList.replace('text-gray-400', 'text-blue-600');
            if(id.includes('settings')) document.querySelector('nav button:nth-child(4)').classList.replace('text-gray-400', 'text-blue-600');
        };

        // --- GEMINI AI ---
        function checkKey() {
            const has = !!geminiKey;
            if(document.getElementById('key-status')) document.getElementById('key-status').textContent = has ? "✅ Key Saved" : "❌ No Key Set";
            
            document.querySelectorAll('.gemini-feature').forEach(e => {
                if(!has) e.classList.add('disabled-card');
                else e.classList.remove('disabled-card');
            });
            if(has && document.getElementById('api-key')) document.getElementById('api-key').value = geminiKey;
        }

        if(document.getElementById('save-key')) {
            document.getElementById('save-key').onclick = () => {
                const k = document.getElementById('api-key').value.trim();
                if(k) { localStorage.setItem('geminiKey', k); geminiKey = k; checkKey(); }
            };
        }

        async function askGemini(prompt) {
            if(!geminiKey) return;
            const modal = document.getElementById('ai-modal');
            const box = document.getElementById('ai-content');
            modal.classList.remove('hidden');
            box.innerHTML = '<div class="loader"></div>';
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                box.innerHTML = marked.parse(text);
            } catch(e) {
                box.innerHTML = "Error connecting to AI. Check your internet or API key.";
            }
        }
        
        if(document.getElementById('ai-guide-btn')) {
            document.getElementById('ai-guide-btn').onclick = () => askGemini(`I just scored ${document.getElementById('final-score').textContent} on a ${activeSubject} quiz. Give me 3 bullet points of study tips.`);
        }
        if(document.getElementById('mock-exam-btn')) {
            document.getElementById('mock-exam-btn').onclick = () => { openSetup('Mock Exam'); };
        }

        // Initialize
        if(currentUser) { 
            updateUserDisplay();
            // Go to home if already logged in
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('home-screen').classList.remove('hidden');
        }
        checkKey();
    </script>
